name: Deploy Dockerfile Directly

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repository (کد را می‌آورد)
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ اتصال امن به سرور و اجرای Docker
      - name: Build and run Docker on server
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.SERVER_IP }}        # IP سرور
          username: ${{ secrets.SERVER_USER }}  # یوزر SSH
          key: ${{ secrets.DEPLOY_KEY }}       # private key امن از GitHub Secrets
          script: |
            # توقف و حذف کانتینر قبلی
            docker stop web || true
            docker rm web || true

            # حذف ایمیج قدیمی (اختیاری)
            docker rmi nginxalpine || true

            # Build جدید از Dockerfile
            docker build -t nginxalpine .

            # اجرای کانتینر جدید
            docker run -d --name web -p 80:80 nginxalpine
