name: CI/CD Pipeline

# روی چه event ای اجرا بشه
on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout کردن کد از مخزن
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. ورود به Docker Hub یا registry محلی (اختیاری)
      # اگر میخوای ایمیج رو push کنی به Docker Hub، میتونی این مرحله اضافه کنی
      # - name: Login to DockerHub
      #   uses: docker/login-action@v2
      #   with:
      #     username: ${{ secrets.DOCKER_USERNAME }}
      #     password: ${{ secrets.DOCKER_PASSWORD }}

      # 3. Build Docker images
      - name: Build Docker images
        run: docker-compose -f docker-compose.yml build

      # 4. Deploy روی سرور از طریق SSH
      - name: Deploy on server via SSH
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          script: |
            cd /path/to/your/project
            # توقف کانتینرهای قدیمی
            docker-compose down
            # Pull آخرین کد از گیت (در صورت نیاز)
            git pull origin main
            # Build و run کانتینرها
            docker-compose up -d --build
